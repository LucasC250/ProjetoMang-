<app-toolbar></app-toolbar>

<div class="leitor-container">
  <!-- LOADING -->
  <div *ngIf="loading" class="text-center p-6">
    <p-progressSpinner></p-progressSpinner>
    <p class="mt-3 text-color-secondary">Carregando capítulo...</p>
  </div>

  <!-- REDIRECIONAMENTO PARA URL EXTERNA -->
  <div *ngIf="!loading && error && hasExternalUrl && externalUrl" class="text-center p-6 max-w-4xl mx-auto">
    <i class="pi pi-external-link text-4xl text-blue-500 mb-3"></i>
    <p class="text-xl font-bold text-blue-500 mb-2">Capítulo disponível externamente</p>
    <p class="text-color-secondary mb-4">{{ errorMessage }}</p>

    <!-- CONTAGEM REGRESSIVA -->
    <div class="mb-6">
      <div class="flex justify-content-center align-items-center gap-3">
        <p-progressSpinner
          *ngIf="redirectCountdown > 0"
          styleClass="w-2rem h-2rem"
          strokeWidth="4"
        ></p-progressSpinner>
        <div>
          <p class="font-bold text-lg mb-1">{{ redirectCountdown }}</p>
          <p class="text-sm text-color-secondary">segundos</p>
        </div>
      </div>
    </div>

    <!-- BOTÕES DE AÇÃO -->
    <div class="flex flex-wrap justify-content-center gap-3 mt-4">
      <p-button
        label="Acessar Agora"
        icon="pi pi-external-link"
        (click)="redirectNow()"
        class="p-button-success"
      ></p-button>

      <p-button
        label="Voltar aos Capítulos"
        icon="pi pi-arrow-left"
        (click)="voltarParaCapitulos()"
        class="p-button-outlined"
      ></p-button>
    </div>

    <!-- INFORMAÇÕES DA URL -->
    <div class="mt-6 p-4 border-round surface-50">
      <p class="font-bold mb-2">
        <i class="pi pi-link mr-2"></i>
        Site oficial do capítulo:
      </p>
      <div class="p-3 border-round surface-100">
        <code class="text-sm break-all">{{ externalUrl }}</code>
      </div>
      <p class="text-sm text-color-secondary mt-2">
        <i class="pi pi-info-circle mr-1"></i>
        Este é o site oficial da editora onde o capítulo está disponível legalmente.
      </p>
    </div>
  </div>

  <!-- ERRO SEM URL EXTERNA -->
  <div *ngIf="!loading && error && !hasExternalUrl" class="text-center p-6 max-w-4xl mx-auto">
    <i class="pi pi-exclamation-triangle text-4xl text-red-500 mb-3"></i>
    <p class="text-xl font-bold text-red-500 mb-2">Capítulo não disponível</p>
    <p class="text-color-secondary mb-4">{{ errorMessage }}</p>

    <!-- FONTES ALTERNATIVAS -->
    <div *ngIf="alternativeSources.length > 0" class="mt-6">
      <p class="font-bold mb-3">Tente estas alternativas:</p>
      <div class="grid">
        <div *ngFor="let source of alternativeSources" class="col-12 md:col-4 mb-3">
          <p-card [header]="source.name" class="h-full">
            <p class="text-sm text-color-secondary mb-3">
              {{ source.type === 'search' ? 'Buscar este mangá' : 'Acessar diretamente' }}
            </p>
            <div class="flex justify-content-end">
              <p-button
                label="Acessar"
                icon="pi pi-external-link"
                (click)="openAlternativeSource(source)"
                styleClass="p-button-outlined p-button-sm"
              ></p-button>
            </div>
          </p-card>
        </div>
      </div>
    </div>

    <!-- AÇÕES -->
    <div class="flex flex-wrap justify-content-center gap-3 mt-6">
      <p-button
        label="Tentar Novamente"
        icon="pi pi-refresh"
        (click)="retryLoad()"
        class="p-button-primary"
      ></p-button>

      <p-button
        label="Voltar aos Capítulos"
        icon="pi pi-arrow-left"
        (click)="voltarParaCapitulos()"
        class="p-button-secondary"
      ></p-button>
    </div>
  </div>

  <!-- LEITOR (quando páginas disponíveis na MangaDex) -->
  <div *ngIf="!loading && !error && pages.length > 0" class="leitor-content">
    <!-- CABEÇALHO -->
    <div class="leitor-header">
      <div class="flex justify-content-between align-items-center mb-3">
        <h2 class="m-0">{{ getChapterTitle() }}</h2>
        <span class="text-color-secondary">
          Página {{ currentPage + 1 }} de {{ pages.length }}
        </span>
      </div>

      <!-- CONTROLES -->
      <div class="flex justify-content-center gap-3 mb-4">
        <p-button
          label="Anterior"
          icon="pi pi-chevron-left"
          (click)="prevPage()"
          [disabled]="currentPage === 0"
          styleClass="p-button-outlined"
        ></p-button>

        <p-button
          label="Próxima"
          icon="pi pi-chevron-right"
          iconPos="right"
          (click)="nextPage()"
          [disabled]="currentPage === pages.length - 1"
          styleClass="p-button-outlined"
        ></p-button>
      </div>

      <!-- PÁGINAS -->
      <div class="pages-selector flex justify-content-center gap-2 mb-4">
        <span
          *ngFor="let page of pages; let i = index"
          (click)="goToPage(i)"
          class="page-dot cursor-pointer"
          [ngClass]="{ 'active': i === currentPage }"
          [title]="'Ir para página ' + (i + 1)"
        >
          {{ i + 1 }}
        </span>
      </div>
    </div>

    <!-- IMAGEM DA PÁGINA -->
    <div class="page-container">
      <img
        [src]="pages[currentPage]"
        [alt]="'Página ' + (currentPage + 1)"
        class="page-image"
      />
    </div>

    <!-- CONTROLES INFERIORES -->
    <div class="leitor-footer mt-4">
      <div class="flex justify-content-center gap-3">
        <p-button
          label="Página Anterior"
          icon="pi pi-chevron-up"
          (click)="prevPage()"
          [disabled]="currentPage === 0"
          styleClass="p-button-text"
        ></p-button>

        <p-button
          label="Próxima Página"
          icon="pi pi-chevron-down"
          (click)="nextPage()"
          [disabled]="currentPage === pages.length - 1"
          styleClass="p-button-text"
        ></p-button>
      </div>

      <div class="text-center mt-3">
        <small class="text-color-secondary">
          Use as setas do teclado para navegar (← → ↑ ↓)
        </small>
      </div>
    </div>
  </div>
</div>
